{% extends "base.html" %}
{% block content %}
<div class="container">
  <h2>Nuevo Encuentro</h2>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="row">
      <div class="col-md-6">{{ form.fechaYHora.label_tag }}{{ form.fechaYHora }}</div>
      <div class="col-md-6">{{ form.video.label_tag }}{{ form.video }}</div>
    </div>
    <div class="row">
      <div class="col-md-6">{{ form.galpon1.label_tag }}{{ form.galpon1 }}</div>
      <div class="col-md-6">{{ form.galpon2.label_tag }}{{ form.galpon2 }}</div>
    </div>
    <div class="row">
      <div class="col-md-4">{{ form.pactada.label_tag }}{{ form.pactada }}</div>
      <div class="col-md-4">{{ form.pago_juez.label_tag }}{{ form.pago_juez }}</div>
      <div class="col-md-4">{{ form.apuesta_general.label_tag }}{{ form.apuesta_general }}</div>
    </div>
    <div class="row">
      <div class="col-md-4">{{ form.premio_mayor.label_tag }}{{ form.premio_mayor }}</div>
      <div class="col-md-4">{{ form.porcentaje_premio_mayor.label_tag }}{{ form.porcentaje_premio_mayor }}</div>
      <div class="col-md-4">{{ form.apuesta_por_fuera.label_tag }}{{ form.apuesta_por_fuera }}</div>
    </div>

    <!-- Participantes -->
    <div class="mt-4">
      <label class="form-label">Participantes</label>
      <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal"
        data-bs-target="#modalParticipantes">
        Seleccionar Participantes
      </button>
      <div id="participantesSeleccionados" class="mt-2"></div>
    </div>

    <!-- Ganador -->
    <div class="mt-4">
      <label class="form-label">Seleccionar Ganador</label>
      <div id="radioGanador">
        <!-- Se llenará dinámicamente -->
      </div>
      <small class="text-muted">Si no se selecciona ningún ganador, se considerará como empate.</small>
    </div>

    <button type="submit" class="btn btn-success mt-4">Guardar Encuentro</button>
  </form>
</div>

<!-- Modal Participantes -->
<div class="modal fade" id="modalParticipantes" tabindex="-1" aria-labelledby="modalParticipantesLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalParticipantesLabel">Seleccionar Gallos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <table class="table table-bordered" id="tablaGallos">
          <thead>
            <tr>
              <th>Seleccionar</th>
              <th>Placa</th>
              <th>Color</th>
              <th>Sexo</th>
            </tr>
          </thead>
          <tbody>
            {% for gallo in gallos %}
            <tr>
              <!-- Aquí: usamos nroPlaca como valor -->
              <td>
                <input type="checkbox"
                       class="form-check-input gallo-checkbox"
                       value="{{ gallo.nroPlaca }}"
                       data-placa="{{ gallo.nroPlaca }}">
              </td>
              <td>{{ gallo.nroPlaca }}</td>
              <td>{{ gallo.color }}</td>
              <td>{{ gallo.sexo }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button"
                class="btn btn-primary"
                id="confirmarParticipantes"
                data-bs-dismiss="modal">
          Confirmar
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  const participantes = new Map();

  // Al hacer clic en "Confirmar Participantes", actualizamos la UI
  document.getElementById("confirmarParticipantes").addEventListener("click", function () {
    const checks = document.querySelectorAll(".gallo-checkbox");
    const cont = document.getElementById("participantesSeleccionados");
    const radios = document.getElementById("radioGanador");
    cont.innerHTML = '';
    radios.innerHTML = '';
    participantes.clear();

    checks.forEach(cb => {
      if (cb.checked) {
        const id = cb.value;
        const placa = cb.dataset.placa;
        participantes.set(id, placa);
        // Badges
        cont.innerHTML += `<span class="badge bg-secondary me-1">${placa}</span>`;
        // Radios para ganador
        radios.innerHTML += `
          <div class="form-check">
            <input class="form-check-input" type="radio" name="ganador" value="${id}" id="g${id}">
            <label class="form-check-label" for="g${id}">${placa}</label>
          </div>`;
      }
    });
  });

  // Al enviar, prevenimos y agregamos inputs hidden
  document.querySelector("form").addEventListener("submit", function (e) {
    e.preventDefault();
    const form = e.target;
    const checks = document.querySelectorAll(".gallo-checkbox");
    const radios = form.querySelectorAll('input[name="ganador"]');
    // Limpiar antiguos hidden
    document.querySelectorAll(".hidden-part").forEach(n => n.remove());

    // Añadir participantes
    participantes.clear();
    checks.forEach(cb => {
      if (cb.checked) participantes.set(cb.value, cb.dataset.placa);
    });
    if (participantes.size < 2) {
      return alert("Debe seleccionar al menos 2 participantes.");
    }
    participantes.forEach((_, id) => {
      form.insertAdjacentHTML("beforeend",
        `<input type="hidden" class="hidden-part" name="participantes" value="${id}">`
      );
    });

    // Añadir ganador si hay
    let ganadorSel = Array.from(radios).find(r => r.checked);
    if (ganadorSel) {
      form.insertAdjacentHTML("beforeend",
        `<input type="hidden" class="hidden-part" name="ganador" value="${ganadorSel.value}">`
      );
    }

    form.submit();
  });
</script>
{% endblock %}
